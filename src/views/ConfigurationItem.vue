<script setup lang="ts">
import { Button } from "@/components/ui/button";
import { BrushCleaning } from "lucide-vue-next";
import { Input } from "@/components/ui/input";
import { computed, onMounted, reactive, ref, shallowRef } from "vue";
import { RouterLink } from "vue-router";
import type { ConfigItem } from "@/models/config_items";
import { getAllConfigItems } from "@/api/config_items";
import { toast } from "vue-sonner";
import { Plus } from "lucide-vue-next";
import ConfigItemPreview from "@/components/ConfigItemPreview.vue";
import {
  SelectValue,
  Select,
  SelectTrigger,
  SelectItem,
  SelectGroup,
  SelectContent,
} from "@/components/ui/select";
import { categorias, estados } from "@/models/config_items";
import { mapToMetric, sortByDate, sortByName } from "@/lib/utils";
import { DonutChart } from "@/components/ui/chart-donut";
import type { ConfigItemMetric } from "@/models/metrics";
import { CardContent, CardTitle, Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";

const data = shallowRef<ConfigItem[]>([]);
const metricsData = reactive<ConfigItemMetric>({
  total: 0,
  byEstado: [],
  byCategoria: [],
});
const isLoading = ref(false);
const searchNombre = ref("");
const searchVersion = ref("");
const searchCategoria = ref("");
const searchEstado = ref("");

const calculateMetrics = (items: ConfigItem[]) => {
  const byEstado: Map<string, number> = new Map();
  const byCategoria: Map<string, number> = new Map();

  items.forEach((item: ConfigItem) => {
    const valueEstado: number | undefined = byEstado.get(item.estado)
      ? byEstado.get(item.estado)! + 1
      : 1;

    byEstado.set(item.estado, valueEstado);

    const valueCategoria: number | undefined = byCategoria.get(item.categoria)
      ? byCategoria.get(item.categoria)! + 1
      : 1;

    byCategoria.set(item.categoria, valueCategoria);
  });

  metricsData.total = items.length;
  metricsData.byEstado = mapToMetric(byEstado);
  metricsData.byCategoria = mapToMetric(byCategoria);
};

const fetchItems = async () => {
  isLoading.value = true;
  try {
    const items: ConfigItem[] = await getAllConfigItems();
    calculateMetrics(items);
    data.value = items.sort((item1, item2) => {
      const res = sortByDate(item1.fecha_creacion, item2.fecha_creacion);

      return res != 0 ? res : sortByName(item1.nombre, item2.nombre);
    });
  } catch (error: any) {
    toast.error(error.message || "Error al cargar los ítems");
    data.value = [];
  } finally {
    isLoading.value = false;
  }
};

const formattedCategorias = computed(() =>
  categorias.map((categoria) => ({
    value: categoria,
    label: categoria,
  })),
);

const formattedEstados = computed(() =>
  estados.map((estado) => ({
    value: estado,
    label:
      estado.charAt(0).toUpperCase() +
      estado.replace("_", " ").slice(1).toLowerCase(),
  })),
);

const filteredItems = computed(() => {
  let filters: ((item: ConfigItem) => boolean)[] = [];

  if (searchNombre.value !== "") {
    filters.push((item: ConfigItem) => {
      return item.nombre
        .toLowerCase()
        .includes(searchNombre.value.toLowerCase());
    });
  }

  if (searchVersion.value !== "") {
    filters.push((item: ConfigItem) => {
      return item.version
        .toLowerCase()
        .includes(searchVersion.value.toLowerCase());
    });
  }

  if (searchCategoria.value !== "") {
    filters.push((item: ConfigItem) => {
      return item.categoria == searchCategoria.value;
    });
  }

  if (searchEstado.value !== "") {
    filters.push((item: ConfigItem) => {
      return item.estado == searchEstado.value;
    });
  }

  return data.value.filter((item: ConfigItem) => {
    let isItemFiltered = true;
    for (let i = 0; i < filters.length; i++) {
      isItemFiltered = isItemFiltered && filters[i](item);
    }

    return isItemFiltered;
  });
});

const resetSearch = () => {
  searchNombre.value = "";
  searchVersion.value = "";
  searchCategoria.value = "";
  searchEstado.value = "";
};

onMounted(() => {
  fetchItems();
});
</script>

<template>
  <h1 class="text-6xl text-center font-bold mb-2">Items de configuración</h1>
  <div class="flex items-center my-2">
    <Button class="ml-auto">
      <RouterLink to="/config-items/new" class="flex">
        <Plus class="w-2 h-4 mr-2" />Crear</RouterLink
      >
    </Button>
  </div>
  <div class="grid grid-cols-3 gap-8 flex items-center">
    <Card class="mx-6 max-w-3/4">
      <div class="justify-items-center items-center">
        <div class="text-4xl font-light">Total {{ metricsData.total }}</div>
      </div>
    </Card>
    <Card class="max-w-max">
      <CardTitle class="text-2xl font-bold text-center">Por estados</CardTitle>
      <CardContent>
        <div class="flex">
          <div class="flex text-nowrap" v-for="estado in metricsData.byEstado">
            <p>{{ estado.name }} ({{ estado.total }})</p>
          </div>
          <DonutChart
            index="name"
            :category="'total'"
            :data="metricsData.byEstado"
            :show-legend="true"
            :type="'pie'"
          />
        </div>
      </CardContent>
    </Card>
    <Card class="max-w-max">
      <CardTitle class="text-2xl font-bold text-center"
        >Por categorias</CardTitle
      >
      <CardContent>
        <div class="flex">
          <div
            class="grid grid-cols-1"
            v-for="categoria in metricsData.byCategoria"
          >
            <!--<p class="text-justify">
              {{ categoria.name }} ({{ categoria.total }})
            </p>-->
            <Badge>{{ categoria.name }} ({{ categoria.total }})</Badge>
          </div>
          <DonutChart
            index="name"
            :category="'total'"
            :data="metricsData.byCategoria"
            :type="'pie'"
          />
        </div>
      </CardContent>
    </Card>
  </div>
  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5 flex py-6">
    <div>
      <b>Nombre</b>
      <Input
        id="searchNombre"
        type="text"
        placeholder="Buscar por nombre..."
        v-model="searchNombre"
      />
    </div>
    <div>
      <b>Versión</b>
      <Input
        id="searchVersion"
        type="text"
        placeholder="Buscar por versión..."
        v-model="searchVersion"
      />
    </div>
    <div>
      <b>Categoría</b>
      <Select v-model="searchCategoria">
        <SelectTrigger>
          <SelectValue placeholder="Buscar por categoría..." />
        </SelectTrigger>
        <SelectContent class="capitalize">
          <SelectGroup>
            <SelectItem
              v-for="categoria in formattedCategorias"
              :key="categoria.value"
              :value="categoria.value"
              >{{ categoria.label }}</SelectItem
            >
          </SelectGroup>
        </SelectContent>
      </Select>
    </div>
    <div>
      <b>Estado</b>
      <Select v-model="searchEstado">
        <SelectTrigger>
          <SelectValue placeholder="Buscar por estado..." />
        </SelectTrigger>
        <SelectContent class="capitalize">
          <SelectGroup>
            <SelectItem
              v-for="estado in formattedEstados"
              :key="estado.value"
              :value="estado.value"
              >{{ estado.label }}</SelectItem
            >
          </SelectGroup>
        </SelectContent>
      </Select>
    </div>
    <div class="pt-6">
      <Button @click="resetSearch()"><BrushCleaning /> Limpiar filtro</Button>
    </div>
  </div>
  <ul class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-5">
    <div v-for="item in filteredItems" class="grid">
      <li class="grid gap-4">
        <ConfigItemPreview :item="item" />
      </li>
    </div>
  </ul>
</template>
